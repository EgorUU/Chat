(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[408],{1098:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>v});var a=t(5155);t(7828);var r=t(2610),n=t(6874),o=t.n(n),c=t(2115),l=t(4298),i=t(7766),m=t(4540);t(6204);var d=t(1491),u=t(748),h=t(3464),g=t(5899);let v=()=>{let[e,s]=(0,c.useState)([]),[t,n]=(0,c.useState)(null);(0,c.useEffect)(()=>{let e=(0,l.io)(d.m,{withCredentials:!0,transports:["websocket","polling"]});return n(e),e.on("connect_error",e=>{console.error("Ошибка подключения:",e.message)}),null==e||e.on("create_message",e=>{s(s=>[...s,e])},[]),null==e||e.on("load_history",async()=>{}),(null==j?void 0:j.name.length)>0&&v(),()=>{e.off("create_message"),e.disconnect()}},[]);let v=async()=>{let e=j.name,s=await h.A.post(d.V+"/show_rooms",{currName:e});f((0,i.Ic)(s.data.rooms)),console.log(N)},p=(0,c.useRef)(null),f=(0,m.wA)();(0,c.useEffect)(()=>{var e;null==p||null==(e=p.current)||e.scrollIntoView()},[e]);let x=(0,c.useRef)(null),w=async()=>{var e,s;if((null==x||null==(e=x.current)?void 0:e.value)!=""){let e={text:null==(s=x.current)?void 0:s.value,userId:j.id,room:y,userName:j.name?j.name:"Неизвестный",time:"".concat(new Date().getHours()>9?new Date().getHours():"0"+new Date().getHours(),":").concat(new Date().getMinutes()>9?new Date().getMinutes():"0"+new Date().getMinutes())};x.current&&(x.current.value="",x.current.blur()),await t.emit("send_message",e),f((0,i.E)({currentRoom:y,message:e}));let a=N.find(e=>e.id===y).participants.filter(e=>e!==j.name)[0];console.log(a);try{console.log("succ"),console.log({message:e,user:a});let s=await h.A.post(d.V+"/send-message",{message:e,user:e.userName});setTimeout(async()=>{s.data.succes&&(console.log("Успешно",e.userName),await h.A.post(d.V+"/send-message",{message:e,user:a}))},2e3)}catch(e){console.log("cwerr")}console.log(a)}},j=(0,m.d4)(e=>e.currentAccount),_=(0,c.useCallback)(e=>{"Enter"===e.key&&w()},[w]);(0,c.useEffect)(()=>{let e=x.current;if(!e)return;let s=()=>{document.addEventListener("keydown",_)},t=()=>{document.removeEventListener("keydown",_)};return e.addEventListener("focus",s),e.addEventListener("blur",t),()=>{e.removeEventListener("focus",s),e.removeEventListener("blur",t),document.removeEventListener("keydown",_)}},[_]);let N=(0,m.d4)(e=>e.currentRooms.rooms),[y,E]=(0,c.useState)(0),k=(0,c.useRef)(null),[C,b]=(0,c.useState)([]),A=(0,g.n)({mutationFn:async()=>{let e=j.name;return(await h.A.post(d.V+"/show_rooms",{currName:e})).data},onSuccess:e=>{let t=e.rooms.find(e=>e.id===y).messages;s(e=>[...t])},onError:e=>{}});(0,c.useEffect)(()=>{A.mutate()},[y]);let I=async()=>{if(k.current){console.log(k.current.value);let e=k.current.value;console.log(d.V+"/search-users");try{let s=await h.A.post(d.V+"/search-users",{value:e});s.data?b([s.data.name]):b([])}catch(e){console.error("Ошибка при поиске польователей")}}};return(0,a.jsx)(a.Fragment,{children:j.name.length>0?(0,a.jsx)("div",{className:"messager-main",style:{height:"".concat((()=>{let[e,s]=(0,c.useState)(window.innerHeight);return(0,c.useEffect)(()=>{let e=()=>{s(window.innerHeight)};return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),e})()-56,"px")},children:(0,a.jsx)("div",{className:"messager",children:(0,a.jsxs)("div",{className:"messager__chat-background",children:[(0,a.jsxs)("div",{className:"rooms",children:[(0,a.jsxs)("div",{className:"rooms-search",children:[(0,a.jsxs)("form",{action:"",children:[(0,a.jsx)("input",{type:"search",ref:k,placeholder:"Найдите собеседника начиная с @",onChange:e=>{}}),(0,a.jsx)(u.uG9,{onClick:I})]}),C.length>0&&(0,a.jsx)("div",{className:"found-users",children:C.map((e,s)=>(0,a.jsx)("div",{className:"found-users__name",onClick:async()=>{let s=!0;if(N.forEach(e=>{(e.participants[0]===k.current.value&&e.participants[1]===j.name||e.participants[1]===k.current.value&&e.participants[0]===j.name)&&(alert("Чат с таким пользователем уже создан!"),s=!1,k.current.value="",I())}),s){let s=e.slice(1,e.length),t=j.name;await h.A.post(d.V+"/add_room",{newName:s,myName:t}),v(),k.current.value="",I()}},children:(0,a.jsx)("h1",{children:e})},s))})]}),N.length>0&&(0,a.jsx)(a.Fragment,{children:N.map(e=>(0,a.jsx)("div",{className:"room ".concat(y===e.id?"room-active":""),onClick:()=>{t.emit("join_room",{lastId:y,newId:e.id,newMessages:e.messages}),E(e.id)},children:(0,a.jsx)("h1",{children:e.participants.filter(e=>e!=j.name)[0]})}))})]}),(0,a.jsxs)("div",{className:"messager__chat",children:[(0,a.jsxs)("div",{className:"messager__chat-messages",children:[e.map((e,s)=>(0,a.jsxs)("div",{className:"messager__chat-messages-message ".concat(j.id==e.userId?"you":""),children:[(0,a.jsxs)("div",{className:"messager__chat-messages-message-container",children:[(0,a.jsx)("h3",{className:"messager__chat-messages-message-name",children:e.userName}),(0,a.jsx)("h1",{children:e.text})]}),(0,a.jsx)("h2",{className:"messager__chat-messages-message-time",children:e.time})]},s)),(0,a.jsx)("div",{ref:p})]}),0!==y&&(0,a.jsxs)("div",{className:"messager__chat-input",children:[(0,a.jsx)("div",{className:"file",title:"Прикрепить Файл",children:(0,a.jsx)(r.zFp,{})}),(0,a.jsx)("input",{type:"text",ref:x,placeholder:"Напишите Сообщение"}),(0,a.jsx)("button",{className:"send",title:"Отправить",onClick:w,children:(0,a.jsx)(r.JuC,{})})]})]})]})})}):(0,a.jsxs)("div",{className:"welcome",children:[(0,a.jsx)("h1",{children:"Добро пожаловать в Chat!"}),(0,a.jsxs)("h2",{children:["Для общения ",(0,a.jsx)(o(),{href:"/login",children:"Войдите"})," в аккаунт, или ",(0,a.jsx)(o(),{href:"/register",children:"Зарегистрируйтесь."})]})]})})}},1491:(e,s,t)=>{"use strict";t.d(s,{V:()=>r,m:()=>a});let a="https://chat-server2-p344.onrender.com",r="https://chat-server-1-5wi9.onrender.com"},4827:(e,s,t)=>{Promise.resolve().then(t.bind(t,1098))},6204:()=>{},7766:(e,s,t)=>{"use strict";t.d(s,{Ay:()=>r,E:()=>c,Ic:()=>o});let a=(0,t(1990).Z0)({name:"currentRooms",initialState:{rooms:[]},reducers:{setAllRooms:(e,s)=>{e.rooms=s.payload},setRooms:(e,s)=>{e.rooms=[...e.rooms,s.payload]},setNewMessage:(e,s)=>{let t=s.payload.currentRoom,a=s.payload.message;e.rooms[e.rooms.findIndex(e=>e.id===t)].messages=[...e.rooms[e.rooms.findIndex(e=>e.id===t)].messages,a]}}}),r=a.reducer,{setRooms:n,setAllRooms:o,setNewMessage:c}=a.actions},7828:()=>{}},e=>{var s=s=>e(e.s=s);e.O(0,[903,615,206,202,594,174,874,327,441,684,358],()=>s(4827)),_N_E=e.O()}]);